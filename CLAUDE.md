# Sebastian Project - Legacy Migration Mode

**프로젝트**: 3개 게임 현지화 도구 통합 (M4/GL, NC/GL, LY/GL)
**접근 방식**: 레거시 코드 마이그레이션 (TDD 대신 복사 우선)

---

## 🎯 핵심 원칙

### 1. 복사 우선, 재구현 금지
- 레거시 코드를 분석하여 재작성하지 않고 **정확히 복사**
- "더 나은 방법"을 제안하지 않음
- 알고리즘, 데이터 처리 로직, 서식 지정 등 **한 줄도 변경 금지**

### 2. 최소 변경
- UI 의존성 제거를 위한 최소한의 변경만 허용
- 허용되는 변경:
  - ✅ 함수명 변경 (run_merge → merge_dialogue)
  - ✅ 함수 시그니처 변경 (인자 순서, 타입 힌트)
  - ✅ UI 임포트 제거 (tkinter, customtkinter)
  - ✅ progress_queue 인자 추가
- 금지되는 변경:
  - ❌ 로직 최적화, 리팩토링
  - ❌ 중복 제거 (DRY)
  - ❌ 매직 넘버 상수화
  - ❌ 변수명 변경

### 3. 100% 동작 보장
- 출력 파일이 레거시와 **완전히 일치**해야 함
- pandas.DataFrame.equals() → True
- openpyxl 서식 지정도 동일
- LY/GL Round-trip 무결성 100%

### 4. 검증 필수
- 각 작업 완료 후 즉시 검증
- diff로 변경사항 확인
- 출력 파일 비교
- 단위 테스트 실행 (LY/GL 37개)

---

## 📚 작업 가이드 우선순위

이 프로젝트의 작업 지시는 다음 순서로 따릅니다:

1. **Phase 가이드** (가장 높은 우선순위)
   - `prd/Sebastian-Phase1-Logic-Extraction.md`
   - `prd/Sebastian-Phase2-UI-Development.md`
   - `prd/Sebastian-Phase3-Integration.md`

2. **작업 프로토콜**
   - `prd/Sebastian-Claude-Code-Protocol.md`

3. **Wireframe** (UI 작업 시)
   - `prd/Sebastian-UI-Wireframes.md`

4. **전체 개요**
   - `prd/Sebastian-Migration-Guide.md`

---

## 🚫 TDD 원칙 비활성화

이 프로젝트에서는 다음 원칙을 **적용하지 않습니다**:

### ❌ Red → Green → Refactor 사이클
- 테스트 먼저 작성하지 않음
- 레거시 코드가 이미 존재하고 동작함
- 최소 구현 대신 **전체 로직 복사**

### ❌ Tidy First (구조 개선)
- 복사 전 구조 개선하지 않음
- 함수 분리, 추출 금지
- 레거시 구조 그대로 유지

### ❌ DRY (중복 제거)
- M4/GL과 NC/GL에 유사 코드 있어도 그대로 유지
- 공통 유틸리티 추출 금지
- 각 게임별 독립성 유지

### ❌ Refactoring (리팩토링)
- Green 단계에서도 리팩토링 금지
- Phase 1-3에서는 코드 개선 전혀 하지 않음
- Phase 5 (최적화)에서만 고려

---

## 📦 Phase별 작업 방식

### Phase 1: 로직 추출 (복사만)

**목표**: `legacy/` → `sebastian/core/` 복사

**작업 방식**:
```
1. 정확한 라인 범위 복사 (예: 74-266행)
2. 함수명만 변경 (run_merge → merge_dialogue)
3. progress_queue 인자 추가
4. diff 확인 → 예상대로만 변경되었는지 검증
5. 수동 검증 → 핵심 로직 보존 확인
```

**금지 사항**:
- ❌ 코드 이해하고 재작성
- ❌ "더 좋은 방법" 제안
- ❌ 타입 힌트 과도 추가
- ❌ 주석 추가

**검증**:
```bash
diff legacy/M4/Merged_M4.py sebastian/core/m4gl/dialogue.py
# → 함수명, 인자 외 변경 없음 확인
```

---

### Phase 2: UI 개발 (신규 작성)

**목표**: PyQt6 UI 신규 구축

**작업 방식**:
```
1. wireframe 100% 준수
2. 레거시 UI 참조 금지 (이미지 버튼, 절대 좌표 등)
3. Signal/Slot 패턴
4. 공통 컴포넌트 재사용
```

**TDD 적용 여부**: ⚔️ 선택적 허용
- UI 로직에 한해 테스트 작성 가능
- 하지만 wireframe 준수가 최우선

**검증**:
- wireframe 디자인 일치
- 색상 코드 정확성
- 레이아웃 반응성

---

### Phase 3: 통합 (연결 + 검증)

**목표**: UI ↔ Core 연결 및 레거시 동작 검증

**작업 방식**:
```
1. QThread Worker 작성
2. Signal/Slot 연결
3. 실제 데이터로 테스트
4. 출력 파일 비교 (레거시 vs 신규)
```

**TDD 적용 여부**: ✅ 부분 적용
- 통합 테스트는 TDD 방식 가능
- 하지만 레거시 로직은 변경 금지

**검증**:
```python
# tests/test_m4gl.py
def test_dialogue_output():
    df_legacy = pd.read_excel('legacy_output.xlsx')
    df_new = pd.read_excel('new_output.xlsx')
    assert df_legacy.equals(df_new)  # 100% 일치
```

---

## 🛠️ 작업 지시 템플릿 준수

모든 작업은 `prd/Sebastian-Claude-Code-Protocol.md`의 템플릿을 따릅니다.

### Template 1: 파일 복사 (Phase 1)
```
"[소스 파일 경로]:[시작행]-[종료행]을
[타겟 파일 경로]로 복사해줘.

다음 변경사항만 적용:
1. 함수명: [old] → [new]
2. 인자: [추가/제거]

나머지는 한 줄도 변경하지 마.

특히 다음 항목은 절대 변경 금지:
- [보존 항목 1]
- [보존 항목 2]"
```

### Template 2: UI 구현 (Phase 2)
```
"[UI 파일 경로]를 작성해줘.
wireframe의 '[섹션명]' 섹션을 참조하세요.

요구사항:
1. [요구사항 1]
2. [요구사항 2]"
```

### Template 3: 검증
```
"[검증 대상]을(를) 검증해줘.

방법:
1. diff 실행
2. [검증 항목] 확인

예상 결과:
- [예상 1]
- [예상 2]"
```

---

## ✅ 검증 체크리스트

### 각 작업 완료 후 즉시 수행

**Phase 1 (로직 추출)**:
- [ ] diff 실행: 함수명, 인자 외 변경 없음
- [ ] 수동 확인: 파일 읽기 파라미터 (sheet_name, header_row, skip_rows)
- [ ] 수동 확인: 컬럼 매핑 딕셔너리 (정확한 인덱스)
- [ ] 수동 확인: 서식 지정 (Font, PatternFill, Border 색상 코드)
- [ ] 임포트 테스트: `from core.m4gl import merge_dialogue`

**Phase 2 (UI 개발)**:
- [ ] wireframe 디자인 100% 준수
- [ ] 색상 시스템 일치 (#4CAF50, #2196F3 등)
- [ ] 타이포그래피 일치 (Pretendard, 맑은 고딕)
- [ ] 간격 시스템 일치 (4px, 8px, 16px, 24px, 32px)
- [ ] UI 실행 테스트

**Phase 3 (통합)**:
- [ ] Worker 정상 실행
- [ ] ProgressDialog 업데이트
- [ ] 출력 파일 생성
- [ ] **레거시 vs 신규: 100% 일치** (가장 중요!)

---

## 🚨 주의사항

### 절대 하지 말 것
1. ❌ "이 코드는 비효율적입니다" → 레거시 그대로 유지
2. ❌ "중복 코드를 제거하겠습니다" → 중복 유지
3. ❌ "더 좋은 방법이 있습니다" → 제안하지 않음
4. ❌ "리팩토링하겠습니다" → Phase 1-3에서는 금지
5. ❌ "테스트를 먼저 작성하겠습니다" → 레거시 복사가 우선

### 허용되는 작업
1. ✅ "legacy/M4/Merged_M4.py:74-266을 복사했습니다"
2. ✅ "함수명을 merge_dialogue()로 변경했습니다"
3. ✅ "diff 결과, 예상대로 변경되었습니다"
4. ✅ "wireframe 디자인대로 구현했습니다"
5. ✅ "출력 파일이 레거시와 100% 일치합니다"

---

## 💬 질문 및 확인

### 불명확한 경우 즉시 질문
```
"지시사항에 [항목]이 명시되지 않았습니다.
[옵션 1] vs [옵션 2] 중 어떤 방식으로 진행할까요?"
```

### 예상과 다른 경우 즉시 보고
```
"diff 결과, 예상과 다른 변경사항이 발견되었습니다:
- [변경 항목]

이것이 의도된 것인가요?"
```

### 검증 실패 시 즉시 보고
```
"출력 파일 비교 결과, 다음 항목이 불일치합니다:
- [불일치 항목]

원인: [추정 원인]
해결 방안: [제안]"
```

---

## 📊 성공 기준

### Phase 1 완료 기준
- [ ] `sebastian/core/` 구조 완성
- [ ] 모든 함수 복사 완료
- [ ] diff 검증: 함수명, 인자 외 변경 없음
- [ ] 의존성 확인: pandas, openpyxl, xlsxwriter

### Phase 2 완료 기준
- [ ] `sebastian/ui/` 구조 완성
- [ ] wireframe 100% 구현
- [ ] 모든 탭 정상 표시
- [ ] 공통 컴포넌트 재사용

### Phase 3 완료 기준
- [ ] 모든 기능 정상 동작
- [ ] **M4/GL 출력: 레거시와 100% 일치** ⭐
- [ ] **NC/GL 출력: 레거시와 100% 일치** ⭐
- [ ] **LY/GL 출력: 레거시와 100% 일치** ⭐
- [ ] **LY/GL Round-trip: 원본 복원 100%** ⭐
- [ ] **LY/GL 37개 단위 테스트: 100% 통과** ⭐

---

## 🔄 작업 흐름

### 전형적인 작업 시퀀스
```
1. Phase 가이드 확인
   ↓
2. Task의 "Claude Code 지시" 부분 확인
   ↓
3. 정확히 지시대로 수행 (추론/변형 금지)
   ↓
4. 즉시 검증 (diff, 테스트, 출력 파일 비교)
   ↓
5. 검증 통과 → 다음 Task
   검증 실패 → 보고 및 수정
```

### 단계별 진행 (한 번에 하나만)
```
Task 1 완료 → 검증 → Task 2 완료 → 검증 → Task 3 완료 → ...
```

**❌ 잘못된 방식**:
```
Task 1, 2, 3 한꺼번에 → 마지막에 검증 (❌ 에러 발견 시 되돌리기 어려움)
```

---

## 📅 다음 단계 안내

새로운 세션에서 작업 시작 시:

1. **Phase 확인**: 현재 어느 Phase인지 확인
2. **가이드 참조**: 해당 Phase 가이드 문서 열기
3. **Task 수행**: "Claude Code 지시" 부분을 정확히 따름
4. **검증**: 각 Task 완료 후 즉시 검증
5. **다음 Task**: 검증 통과 시에만 다음 진행

---

이 문서의 원칙을 엄격히 따라주세요.
레거시 코드를 "이해"하려 하지 말고, **정확히 복사**하는 것이 핵심입니다.
